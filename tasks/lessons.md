# National Premier League — Lessons & Reference for AI Agents

This document captures mistakes, fixes, and patterns discovered during development. Any AI agent working on this project should read this file first.

---

## Project Setup

### Lesson 1: create-next-app interactive prompts
**Problem**: `npx create-next-app` has interactive prompts (React Compiler, src directory) that cannot be reliably automated via stdin piping.
**Fix**: Set up the project manually — write package.json, tsconfig.json, next.config.ts, postcss.config.mjs, and app/ directory by hand. This is faster and more reliable for automated setups.

### Lesson 2: Tailwind CSS v4 configuration
**Pattern**: Tailwind v4 uses `@import "tailwindcss"` in CSS (not `@tailwind` directives). PostCSS config uses `@tailwindcss/postcss` plugin, not the old `tailwindcss` plugin. There is NO tailwind.config.ts file in v4 — theme customization goes in CSS using `@theme`.

### Lesson 3: Static export with better-sqlite3
**Pattern**: When using `output: "export"` in next.config.ts, better-sqlite3 (a native module) must be listed in `serverExternalPackages`. The database is only read at build time — there's no runtime server. All pages must be statically generated.

---

## Architecture Decisions

### SQLite as build-time data store
- Database at `data/npl.db` — gitignored, regenerated by pipeline
- No ORM: raw SQL via better-sqlite3 is simpler for read-only queries
- All data access happens in `lib/queries.ts` — typed functions that return typed objects
- At build time, Next.js pages call queries → render static HTML
- Client-side interactivity uses pre-built JSON bundles from `public/data/`

### Scoring methodology
- Min-max normalization (0-100 scale, 100 = best)
- Outlier capping at 2nd/98th percentile before normalization
- Polarity: positive (higher=better) or negative (lower=better)
- Category score = weighted average of metric scores
- Overall score = equal-weight average across 27 categories
- Tiers: Champion (>=75), Contender (60-74), Rising (45-59), Developing (<45)

### MoSPI MCP Server
- URL: https://mcp.mospi.gov.in/sse (SSE transport)
- 4-step workflow: know_about → get_indicators → get_metadata → get_data
- 7 datasets: PLFS, CPI, WPI, IIP, NAS, ASI, Energy
- Returns JSON with nested structure — needs flattening before DB insertion

---

## File Paths & Key Files

| File | Purpose |
|------|---------|
| `lib/db.ts` | better-sqlite3 singleton connection |
| `lib/queries.ts` | All SQL queries as typed functions |
| `lib/types.ts` | TypeScript types (State, Metric, Score, etc.) |
| `lib/constants.ts` | State list, category list, color maps |
| `lib/scoring.ts` | Normalization functions |
| `scripts/seed-reference.ts` | Seeds states, categories, metrics tables |
| `scripts/ingest-mospi.ts` | MoSPI MCP client |
| `scripts/compute-scores.ts` | Scoring engine |
| `scripts/generate-json.ts` | JSON bundle export |
| `scripts/pipeline.ts` | Orchestrator |
| `data/reference/` | Committed JSON reference data |
| `data/npl.db` | SQLite database (gitignored) |
| `public/data/` | Pre-built JSON bundles (gitignored) |

---

## Common Gotchas

1. **Static export**: No `getServerSideProps`, no API routes, no `revalidate`. All data must be available at `next build` time.
2. **Dynamic routes**: Must use `generateStaticParams()` to pre-render all state/category pages.
3. **better-sqlite3 in Next.js**: Only works in server components / build scripts. Never import in client components.
4. **India TopoJSON**: State boundaries file at `data/geo/india-states.topojson`. State IDs must match the `id` field in the states table.
5. **MoSPI MCP**: The SSE endpoint may be slow. Script should handle timeouts gracefully.
6. **react-simple-maps peer deps**: Requires `--legacy-peer-deps` or `.npmrc` with `legacy-peer-deps=true` because it declares peer dependency on React 16/17/18, not React 19. Works fine at runtime despite the warning.
7. **Next.js App Router params**: In Next.js 15+, `params` in dynamic route components is a `Promise`. Must be `await`ed: `const { stateId } = await params;`

---

## Mistakes Made During Phase 0

### Mistake 1: Tried to use create-next-app non-interactively
**What happened**: Tried `create-next-app` with flags and stdin piping. The tool has interactive prompts (React Compiler, src directory) that blocked.
**Time wasted**: ~3 minutes
**Fix**: Set up manually. Write package.json, tsconfig.json, next.config.ts by hand.
**Prevention**: For automated/CI environments, always set up Next.js manually.

### Mistake 2: npm install failed due to peer dependency conflict
**What happened**: `react-simple-maps@3.0.0` declares `peer react@"^16.8.0 || 17.x || 18.x"` but we use React 19.
**Time wasted**: ~2 minutes
**Fix**: Added `.npmrc` with `legacy-peer-deps=true`. The library works fine with React 19.
**Prevention**: Always add `.npmrc` with `legacy-peer-deps=true` when using libraries that haven't updated peer deps.

### Mistake 3: MoSPI MCP server connection failed
**What happened**: The SSE endpoint at `https://mcp.mospi.gov.in/sse` returned "Not Found" on direct curl and ECONNRESET via MCP SDK.
**Impact**: Could not fetch real government data for initial build.
**Workaround**: Created `scripts/seed-sample-data.ts` with realistic synthetic data (state development tiers × metric ranges). Allows full UI development while MCP issues are resolved.
**Next steps**: Debug MCP connection — may need different URL, auth headers, or the server may have changed its endpoint.

---

## How to Rebuild From Scratch

If the database gets corrupted or you need a fresh start:
```bash
npx tsx scripts/seed-reference.ts    # Create schema + seed states/categories/metrics
npx tsx scripts/seed-sample-data.ts  # Insert sample data (or use ingest-mospi.ts for real data)
npx tsx scripts/compute-scores.ts    # Compute metric/category/overall scores
npx tsx scripts/generate-json.ts     # Export JSON bundles to public/data/
npx next build                       # Generate static site
```

## How to Add a New Metric

1. Add the metric definition to `data/reference/metrics.json`
2. Run `npx tsx scripts/seed-reference.ts` to update the metrics table
3. Add data source (MoSPI mapping in `scripts/ingest-mospi.ts` or CSV config)
4. Run ingestion + scoring + JSON export
5. No code changes needed for UI — it reads from scores dynamically

## How to Add a New Page/Route

1. Create directory under `app/` (e.g., `app/new-route/page.tsx`)
2. For dynamic routes, add `generateStaticParams()` that reads from reference data
3. Read data from `public/data/` JSON files (server components) or fetch at runtime (client components)
4. Use `Header` and `Footer` components for consistent layout
