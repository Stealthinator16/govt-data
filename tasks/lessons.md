# National Premier League — Lessons & Reference for AI Agents

This document captures mistakes, fixes, and patterns discovered during development. Any AI agent working on this project should read this file first.

---

## Project Setup

### Lesson 1: create-next-app interactive prompts
**Problem**: `npx create-next-app` has interactive prompts (React Compiler, src directory) that cannot be reliably automated via stdin piping.
**Fix**: Set up the project manually — write package.json, tsconfig.json, next.config.ts, postcss.config.mjs, and app/ directory by hand. This is faster and more reliable for automated setups.

### Lesson 2: Tailwind CSS v4 configuration
**Pattern**: Tailwind v4 uses `@import "tailwindcss"` in CSS (not `@tailwind` directives). PostCSS config uses `@tailwindcss/postcss` plugin, not the old `tailwindcss` plugin. There is NO tailwind.config.ts file in v4 — theme customization goes in CSS using `@theme`.

### Lesson 3: Static export with better-sqlite3
**Pattern**: When using `output: "export"` in next.config.ts, better-sqlite3 (a native module) must be listed in `serverExternalPackages`. The database is only read at build time — there's no runtime server. All pages must be statically generated.

---

## Architecture Decisions

### SQLite as build-time data store
- Database at `data/npl.db` — gitignored, regenerated by pipeline
- No ORM: raw SQL via better-sqlite3 is simpler for read-only queries
- All data access happens in `lib/queries.ts` — typed functions that return typed objects
- At build time, Next.js pages call queries → render static HTML
- Client-side interactivity uses pre-built JSON bundles from `public/data/`

### Scoring methodology
- Min-max normalization (0-100 scale, 100 = best)
- Outlier capping at 2nd/98th percentile before normalization
- Polarity: positive (higher=better) or negative (lower=better)
- Category score = weighted average of metric scores
- Overall score = equal-weight average across 27 categories
- Tiers: Champion (>=75), Contender (60-74), Rising (45-59), Developing (<45)

### MoSPI MCP Server
- URL: `https://mcp.mospi.gov.in/` (trailing slash required)
- Transport: **streamable-http** (NOT SSE — `/sse` path returns 404)
- SDK import: `StreamableHTTPClientTransport` from `@modelcontextprotocol/sdk/client/streamableHttp.js`
- 4-step workflow: `1_know_about_mospi_api` → `2_get_indicators` → `3_get_metadata` → `4_get_data`
- **Critical**: Filter codes for `4_get_data` MUST come from `3_get_metadata` response — cannot be hardcoded or guessed
- 7 datasets: PLFS, CPI, WPI, IIP, NAS, ASI, Energy
- Returns JSON with nested structure — needs flattening before DB insertion

---

## File Paths & Key Files

| File | Purpose |
|------|---------|
| `lib/db.ts` | better-sqlite3 singleton connection |
| `lib/queries.ts` | All SQL queries as typed functions |
| `lib/types.ts` | TypeScript types (State, Metric, Score, etc.) |
| `lib/constants.ts` | State list, category list, color maps |
| `lib/scoring.ts` | Normalization functions |
| `scripts/seed-reference.ts` | Seeds states, categories, metrics tables |
| `scripts/ingest-mospi.ts` | MoSPI MCP client |
| `scripts/compute-scores.ts` | Scoring engine |
| `scripts/generate-json.ts` | JSON bundle export |
| `scripts/pipeline.ts` | Orchestrator |
| `data/reference/` | Committed JSON reference data |
| `data/npl.db` | SQLite database (gitignored) |
| `public/data/` | Pre-built JSON bundles (gitignored) |

---

## Common Gotchas

1. **Static export**: No `getServerSideProps`, no API routes, no `revalidate`. All data must be available at `next build` time.
2. **Dynamic routes**: Must use `generateStaticParams()` to pre-render all state/category pages.
3. **better-sqlite3 in Next.js**: Only works in server components / build scripts. Never import in client components.
4. **India TopoJSON**: State boundaries file at `data/geo/india-states.topojson`. State IDs must match the `id` field in the states table.
5. **MoSPI MCP**: Uses streamable-http at root URL, not SSE. Rate-limit calls (500ms delay). Filter codes must come from metadata step 3.
6. **react-simple-maps peer deps**: Requires `--legacy-peer-deps` or `.npmrc` with `legacy-peer-deps=true` because it declares peer dependency on React 16/17/18, not React 19. Works fine at runtime despite the warning.
7. **Next.js App Router params**: In Next.js 15+, `params` in dynamic route components is a `Promise`. Must be `await`ed: `const { stateId } = await params;`

---

## Mistakes Made During Phase 0

### Mistake 1: Tried to use create-next-app non-interactively
**What happened**: Tried `create-next-app` with flags and stdin piping. The tool has interactive prompts (React Compiler, src directory) that blocked.
**Time wasted**: ~3 minutes
**Fix**: Set up manually. Write package.json, tsconfig.json, next.config.ts by hand.
**Prevention**: For automated/CI environments, always set up Next.js manually.

### Mistake 2: npm install failed due to peer dependency conflict
**What happened**: `react-simple-maps@3.0.0` declares `peer react@"^16.8.0 || 17.x || 18.x"` but we use React 19.
**Time wasted**: ~2 minutes
**Fix**: Added `.npmrc` with `legacy-peer-deps=true`. The library works fine with React 19.
**Prevention**: Always add `.npmrc` with `legacy-peer-deps=true` when using libraries that haven't updated peer deps.

### Mistake 3: MoSPI MCP server connection failed (RESOLVED)
**What happened**: Used `SSEClientTransport` connecting to `https://mcp.mospi.gov.in/sse` — returned 404.
**Root cause**: The server uses **streamable-http** transport at the root URL (`/`), not SSE at `/sse`.
**Fix**: Switched to `StreamableHTTPClientTransport` with URL `https://mcp.mospi.gov.in/` (trailing slash).
**Also**: Filter values must be discovered via `3_get_metadata` — hardcoded human-readable filter strings don't work. Use filter code maps from metadata responses.
**Prevention**: Always test the MCP transport type with a raw curl before writing ingestion code. The streamable-http protocol uses `POST` with `Accept: application/json, text/event-stream` headers.

### Lesson 4: MoSPI dataset state-level availability
**Confirmed state-level data:**
- **PLFS** — 8 indicators (LFPR, WPR, UR, worker distribution, employment conditions, regular wage, casual wage, self-employment earnings). Full 36-state coverage, annual data from 2017-2023.
- **CPI** — Consumer Price Index by state (base_year=2012). 36 states, monthly data 2013-2025. Use December (month_code=12) as annual snapshot. Note: CPI `4_get_data` filters do NOT accept `dataset`/`level` — use only the `api_params` from `3_get_metadata`.
- **ASI** — Annual Survey of Industries. 57 indicators (factories, workers, capital, GVA, wages). 36+ states, annual 2009-2023. Use `nic_code=99999` for all industries.

**National-only (NO state data):**
- **NAS** — National Account Statistics (GDP/GVA). Only national-level aggregates.
- **IIP** — Index of Industrial Production. Uses categories not indicators. No state dimension.
- **WPI** — Wholesale Price Index. Hierarchical commodity codes. No state dimension.
- **ENERGY** — Energy Balance. Supply/consumption only. No state dimension.

### Lesson 5: compute-scores.ts year selection
**Problem**: Using `MAX(year)` for scoring picked 2025, but only CPI had data there. Most metrics had latest data in 2020-2023.
**Fix**: Changed to `ORDER BY COUNT(DISTINCT metric_id) DESC, year DESC` — picks the year with the best metric coverage. Also updated validate-data.ts to match.

### Lesson 6: compute-scores.ts sector/gender NULL filter
**Problem**: PLFS data has `sector=NULL`, but CPI/ASI data has `sector="Combined"`. The query `WHERE sector IS NULL` excluded all CPI/ASI rows.
**Fix**: Changed to a `ROW_NUMBER()` window function that prefers NULL disaggregation but falls back to any row.

### Lesson 7: Null values from MoSPI parsed as zero
**Problem**: CPI returned `"index": null` for Arunachal Pradesh (no data collected). The parser did `parseFloat(item.index || "0")` — the `||` fallback converted null to "0", inserting bogus zero values.
**Fix**: Check `item.field == null || item.field === ""` before parseFloat, and skip the row. Applied to all three parsers (PLFS, CPI, ASI).
**Prevention**: Never use `parseFloat(x || "0")` for API data. Always check for null/empty explicitly first, then skip missing data.

### Lesson 8: MoSPI state name spelling variants
CPI uses standard spellings, but ASI uses "Chattisgarh" (single H) and "Dadra & Nagar Havelli" (double L). Always add spelling variants to `STATE_NAME_MAP` when adding a new dataset.

---

## How to Rebuild From Scratch

If the database gets corrupted or you need a fresh start:
```bash
npx tsx scripts/seed-reference.ts    # Create schema + seed states/categories/metrics
npx tsx scripts/seed-sample-data.ts  # Insert sample data (or use ingest-mospi.ts for real data)
npx tsx scripts/compute-scores.ts    # Compute metric/category/overall scores
npx tsx scripts/generate-json.ts     # Export JSON bundles to public/data/
npx next build                       # Generate static site
```

## How to Add a New Metric

1. Add the metric definition to `data/reference/metrics.json`
2. Run `npx tsx scripts/seed-reference.ts` to update the metrics table
3. Add data source (MoSPI mapping in `scripts/ingest-mospi.ts` or CSV config)
4. Run ingestion + scoring + JSON export
5. No code changes needed for UI — it reads from scores dynamically

## Data Sourcing

### Lesson: NEVER fabricate government data
**Problem**: When asked to create CSV files with government data, the instinct is to generate "realistic-looking" numbers. These are FAKE data even if they look plausible.
**Fix**: Always search the web for real data from government sources. Use WebSearch/WebFetch to find actual published tables. If data can't be found online, create template CSVs with headers only and let the user fill in real data.
**Key sources for Indian government data**:
- NFHS-5 factsheets: GitHub `pratapvardhan/NFHS-5` has all 131 indicators in CSV
- Census 2011: Wikipedia and census2011.co.in have excellent compiled tables
- NCRB: PDFs locked but PMC research articles cite complete state-wise tables
- BPR&D police data: UK government report compiles state-wise figures
- FSI forest cover: geographyhost.com has complete ISFR data
- DPIIT startups: PIB press releases have complete state-wise counts
- PMJDY: pmjdy.gov.in has live state-wise statistics
- MoRTH accidents: PIB press releases have complete fatality counts
- ASI heritage sites: PIB/Ministry of Culture press releases have state-wise counts
- SRS life tables: Only cover 22 major states (population >10M)
**Data locked behind PDFs/dashboards (need manual extraction)**: TRAI telecom, CPCB solid waste, JJM tap water, Swachh Survekshan scores, voter turnout by state assembly

## How to Add a New Page/Route

1. Create directory under `app/` (e.g., `app/new-route/page.tsx`)
2. For dynamic routes, add `generateStaticParams()` that reads from reference data
3. Read data from `public/data/` JSON files (server components) or fetch at runtime (client components)
4. Use `Header` and `Footer` components for consistent layout
