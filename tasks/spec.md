# National Premier League — Technical Specification

## 1. Product Overview

**National Premier League (NPL)** is a static website that ranks and compares all 36 Indian states and Union Territories across 27 categories and ~1000+ metrics of human development and governance. Think of it as a Premier League table for states — making lagging states visible, celebrating leading ones, and driving public awareness through data.

### Core Value Proposition
- **Single source of truth**: Aggregates data from 15+ government sources into one comparable framework
- **Transparency**: Every score is traceable back to source data
- **Accessibility**: Complex statistical data presented as intuitive league tables, maps, and charts

---

## 2. Architecture

### 2.1 Static-First Design
- **Framework**: Next.js 15 with App Router, static export (`output: "export"`)
- **No runtime server**: All pages pre-rendered at build time
- **Data flow**: SQLite (build-time) → Static HTML + JSON bundles → Vercel CDN
- **Client interactivity**: Comparison tool and chart filtering use pre-built JSON bundles

### 2.2 Data Pipeline
```
MoSPI MCP Server ─┐
CSV/Excel files  ──┼─→ Ingestion → SQLite → Scoring → Next.js SSG → Vercel
Other APIs       ──┘       ↓                    ↓            ↓
                      data/npl.db          metric_scores    static HTML
                                           category_scores  + JSON bundles
                                           overall_scores   in public/data/
```

### 2.3 Tech Stack
| Purpose | Library | Why |
|---------|---------|-----|
| Framework | Next.js 15 (App Router) | Static export, React Server Components |
| UI | shadcn/ui + Tailwind CSS v4 | Consistent design, copy-paste components |
| Charts | Recharts (via shadcn) | React-native, good for static rendering |
| Data Tables | @tanstack/react-table | Headless, full control over rendering |
| Maps | react-simple-maps | Lightweight, TopoJSON-based |
| Database | better-sqlite3 | Zero-config, file-based, fast reads |
| MCP Client | @modelcontextprotocol/sdk | Official MoSPI data access |
| CSV/Excel | papaparse + xlsx | Standard parsers |
| Validation | zod | Runtime type checking for data pipeline |

---

## 3. Database Schema

SQLite database at `data/npl.db` (gitignored, regenerated by pipeline).

### 3.1 Reference Tables
```sql
states (id TEXT PK, name, code_mospi, type, population, area_sq_km, region)
-- 36 rows: 28 states + 8 UTs

categories (id TEXT PK, name, description, icon, sort_order)
-- 27 rows: one per measurement category

metrics (id TEXT PK, category_id FK, name, unit, source, polarity, weight, disaggregations JSON, is_featured)
-- ~1000 rows: individual data indicators
```

### 3.2 Data Table
```sql
data_points (id INTEGER PK, metric_id FK, state_id FK, year, period, value REAL,
             gender, sector, age_group, social_group, status, source_ref)
-- UNIQUE(metric_id, state_id, year, period, gender, sector, age_group, social_group)
-- Estimated: 50K-200K rows
```

### 3.3 Score Tables
```sql
metric_scores (metric_id, state_id, year, raw_value, norm_score 0-100, rank)
category_scores (category_id, state_id, year, score 0-100, rank, metrics_count)
overall_scores (state_id, year, score 0-100, rank, tier TEXT)
```

---

## 4. Scoring Methodology

### 4.1 Metric Normalization
- **Method**: Min-max normalization to 0-100 scale (100 = best)
- **Outlier handling**: Values capped at 2nd and 98th percentile before normalization
- **Polarity**:
  - Positive (higher=better): `score = (val - min) / (max - min) × 100`
  - Negative (lower=better): `score = (max - val) / (max - min) × 100`

### 4.2 Category Scores
- Weighted average of all metric scores within the category
- Weights defined per metric in reference data (default: 1.0)

### 4.3 Overall Score
- Equal-weight average across all 27 categories
- Ensures no single domain dominates

### 4.4 Tier Classification
| Tier | Score Range | Color |
|------|-------------|-------|
| Champion | >= 75 | Emerald/Green |
| Contender | 60-74 | Blue |
| Rising | 45-59 | Amber |
| Developing | < 45 | Red |

---

## 5. Page Structure & Routes

### 5.1 Pages (~200-300 pre-rendered)
| Route | Content |
|-------|---------|
| `/` | Homepage: India choropleth map + top-10 table + category cards |
| `/rankings` | Full overall league table (all 36 states) |
| `/rankings/[categoryId]` | Category-specific rankings (×27) |
| `/states` | All states grid with search |
| `/states/[stateId]` | State profile: radar chart + 27 category breakdowns |
| `/compare` | Client-side comparison tool (not pre-rendered per pair) |
| `/metrics/[metricId]` | Single metric deep-dive (~100 featured metrics) |
| `/about` | Methodology, data sources, FAQ |

### 5.2 Dynamic Route Generation
All dynamic routes use `generateStaticParams()` to enumerate:
- 27 category IDs for `/rankings/[categoryId]`
- 36 state IDs for `/states/[stateId]`
- ~100 featured metric IDs for `/metrics/[metricId]`

---

## 6. Component Architecture

### 6.1 Layout Components
- `Header`: Logo, navigation, search trigger, theme toggle
- `Footer`: Data sources, methodology link, last updated date

### 6.2 League Table Components
- `LeagueTable`: Sortable table with rank, state name, score bar, tier badge
- `ScoreBar`: Visual progress bar (0-100) with color based on tier
- `TierBadge`: Colored pill showing Champion/Contender/Rising/Developing

### 6.3 Map Components
- `IndiaMap`: Choropleth map using react-simple-maps + TopoJSON
- `MapTooltip`: Hover state showing state name + score
- `MapLegend`: Color scale legend

### 6.4 Chart Components
- `RadarChart`: Spider chart for state profile (27 category axes)
- `BarChart`: Horizontal bar chart for metric comparisons
- `LineChart`: Time series for trend analysis
- `Sparkline`: Inline mini chart for tables

### 6.5 Comparison Components
- `StateSelector`: Dropdown/search to pick two states
- `ComparisonRadar`: Overlaid radar charts
- `MetricDiffTable`: Side-by-side metric comparison with difference indicators

---

## 7. Data Pipeline

### 7.1 MoSPI MCP Ingestion (`scripts/ingest-mospi.ts`)
Connects to `https://mcp.mospi.gov.in/sse` via MCP SDK.

**4-step workflow per dataset:**
1. `1_know_about_mospi_api()` → list of available datasets
2. `2_get_indicators(dataset)` → indicators within dataset
3. `3_get_metadata(dataset, indicator)` → available filter values (states, years)
4. `4_get_data(dataset, filters)` → actual data values

**Datasets**: PLFS, CPI, WPI, IIP, NAS, ASI, Energy

### 7.2 CSV/Excel Ingestion (`scripts/ingest-csv.ts`)
Config-driven generic ingester reading from `data/raw/` directory.

**Configuration per source**:
- File path and format (CSV/Excel)
- Column mappings (which column = state, value, year, etc.)
- State name normalization (fuzzy matching to canonical state IDs)
- Metric ID assignment
- Value transforms (unit conversion, etc.)

**Sources**: NFHS, NCRB, Census, RBI, UDISE+, AISHE, TRAI, MoRTH, CEA/MNRE, etc.

### 7.3 Scoring Engine (`scripts/compute-scores.ts`)
1. Read all data_points for latest year
2. For each metric: cap outliers → normalize → rank → write to metric_scores
3. For each category × state: weighted average → rank → write to category_scores
4. For each state: average across categories → rank → assign tier → write to overall_scores

### 7.4 JSON Export (`scripts/generate-json.ts`)
Exports pre-computed data to `public/data/` for client-side consumption:
- `public/data/overall.json` — all states with overall scores
- `public/data/categories/{categoryId}.json` — per-category rankings
- `public/data/states/{stateId}.json` — per-state full profile
- `public/data/compare.json` — lightweight comparison dataset

### 7.5 Pipeline Orchestrator (`scripts/pipeline.ts`)
Sequential execution: seed → ingest-mospi → ingest-csv → compute-scores → validate → generate-json

---

## 8. Data Sources

| Source | URL/Access | Categories |
|--------|-----------|------------|
| MoSPI MCP | mcp.mospi.gov.in/sse | Economy, Employment, Prices, Industry, Energy |
| NFHS | rchiips.org | Health, Women, Children, Nutrition |
| Census/SRS | censusindia.gov.in | Demographics, Literacy, Mortality |
| NCRB | ncrb.gov.in | Crime, Police, Prisons |
| UDISE+ | udiseplus.gov.in | School Education |
| AISHE | aishe.gov.in | Higher Education |
| RBI | rbi.org.in | Finance, Banking, State Budgets |
| TRAI | trai.gov.in | Telecom, Internet |

---

## 9. Deployment & Operations

### 9.1 Build Process
```bash
npm run pipeline   # Run full data pipeline
npm run build      # Next.js static build
```

### 9.2 Deployment
- **Platform**: Vercel (static hosting)
- **Build**: Static export generates `out/` directory
- **CDN**: Automatic via Vercel

### 9.3 Monthly Update Cycle
GitHub Actions cron (1st of each month):
1. Run data pipeline
2. Run `next build`
3. Deploy to Vercel

Quarterly: Manual download of latest CSV/Excel from government portals → commit to `data/raw/` → push

---

## 10. Directory Structure

```
govt-data/
├── app/                    -- Next.js pages
│   ├── page.tsx            -- Homepage
│   ├── layout.tsx          -- Root layout
│   ├── globals.css         -- Global styles
│   ├── rankings/
│   │   ├── page.tsx        -- Overall rankings
│   │   └── [categoryId]/page.tsx
│   ├── states/
│   │   ├── page.tsx        -- States grid
│   │   └── [stateId]/page.tsx
│   ├── compare/page.tsx    -- Comparison tool
│   ├── metrics/[metricId]/page.tsx
│   └── about/page.tsx
├── components/
│   ├── ui/                 -- shadcn/ui primitives
│   ├── layout/             -- header, footer
│   ├── league-table/       -- table, row, score-bar, tier-badge
│   ├── map/                -- india-map, tooltip, legend
│   ├── charts/             -- bar, radar, line, sparkline
│   ├── comparison/         -- selector, view, radar, diff-table
│   ├── state-profile/      -- header, breakdown, detail
│   └── shared/             -- data-card, search, category-icon
├── lib/
│   ├── db.ts               -- better-sqlite3 singleton
│   ├── queries.ts          -- Typed SQL query functions
│   ├── types.ts            -- TypeScript interfaces
│   ├── constants.ts        -- State/category lists, colors, tiers
│   ├── scoring.ts          -- Normalization functions
│   └── format.ts           -- Number/date formatting
├── scripts/
│   ├── seed-reference.ts   -- Seed reference tables
│   ├── ingest-mospi.ts     -- MoSPI MCP client
│   ├── ingest-csv.ts       -- CSV/Excel ingester
│   ├── compute-scores.ts   -- Scoring engine
│   ├── generate-json.ts    -- JSON bundle export
│   ├── validate-data.ts    -- Data quality checks
│   └── pipeline.ts         -- Orchestrator
├── data/
│   ├── raw/                -- Source files (gitignored)
│   ├── reference/          -- states.json, categories.json, metrics.json
│   ├── geo/                -- india-states.topojson
│   └── npl.db              -- SQLite database (gitignored)
├── public/data/            -- Pre-built JSON bundles (gitignored)
├── config/sources.ts       -- CSV source configurations
├── tasks/
│   ├── todo.md             -- Implementation progress
│   ├── lessons.md          -- Mistakes & patterns for AI agents
│   └── spec.md             -- This file
├── package.json
├── tsconfig.json
├── next.config.ts
└── postcss.config.mjs
```
